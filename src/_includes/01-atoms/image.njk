{# ┌─────────────────────────────────────────────────────────┐
   │ ATOM › Image                                            │
   │ Responsive images with automated metadata generation    │
   └─────────────────────────────────────────────────────────┘ #}

{#
  Usage — Summon HAT Components Wisely:
    {% from "01-atoms/image.njk" import renderImage %}

    {{ renderImage({
        name: "demoImage1",
        datas: atoms.image.images,
        src: dynamicImageSrc,
        alt: dynamicImageAlt,
        iconDatas: atoms.icon.icons
    }) }}

  Note: width/height auto-generated via bin/sync-image-sizes.js
  Note: <picture> with AVIF + WebP generated by eleventyImageTransformPlugin

  @created 2025-09-15
  @updated 2026-02-24
#}

{% from "01-atoms/icon.njk" import renderIcon %}

{% macro renderImage(options) %}

  {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
    1. Validate Props
  ━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
  {% if not options.datas %}
    <span class="error" role="alert">Error: Missing required prop (datas)</span>
  {% elif not options.name %}
    <span class="error" role="alert">Error: Missing required prop (name)</span>
  {% else %}
    {# Find image using universal filter #}
    {% set imageData = options.datas | findByName(options.name) %}

    {# Render image or error message #}
    {% if not imageData %}
      <span class="error" role="alert">Image not found: {{ options.name }}</span>
    {% else %}

      {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
        2. Compute Final Values
      ━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
      {% set imageSrc = options.src | default(imageData.src) | default('') %}
      {% set imageAlt = options.alt | default(imageData.alt) %}
      {% set imageVariant = imageData.variant | default('default') %}
      {% set imageWidth = imageData.width %}
      {% set imageHeight = imageData.height %}
      {% set hasIcon = imageData.iconName %}
      {% set imageLoading = imageData.loading | default('lazy') %}

      {# Validate alt text for informative images #}
      {% if not imageAlt and imageVariant == 'default' %}
        <span class="error" role="alert">Missing required alt text: {{ imageData.name }}</span>
      {% else %}

      {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
        3. Tailwind Classes
        Index:
        3.1 Base Classes
        3.2 Variant Classes
      ━━━━━━━━━━━━━━━━━━━━━━━━━━ #}

      {# --------------------------
          3.1 Base Classes
          Description: Responsive by default (MDN standard)
      -------------------------- #}
      {% set baseClasses = "block max-w-full h-auto object-cover" %}

      {# --------------------------
          3.2 Variant Classes
          Description: Avatar (fixed UI element) or Default (fluid responsive)
      --------------------------- #}
      {% set variantMap = {
        'avatar': 'w-11 h-11 rounded-[var(--radius-default)]',
        'default': 'w-full'
      } %}
      {% set variantClasses = variantMap[imageVariant] or variantMap['default'] %}

      {# Avatar icon container classes #}
      {% set avatarIconClasses = "inline-flex items-center justify-center w-11 h-11 rounded-[var(--radius-default)] bg-[var(--color-global-contrast-light-04)]" %}

      {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
        4. Render HTML
      ━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
      {% if imageVariant == 'avatar' %}
        {% if hasIcon %}
          {# Avatar with icon #}
          <div
            class="{{ avatarIconClasses }}"
            data-image-name="{{ imageData.name }}"
            data-image-type="avatar-icon"
            role="img"
            aria-label="{{ imageAlt }}"
          >
            {% if options.iconDatas %}
              {{ renderIcon({
                  name: imageData.iconName,
                  datas: options.iconDatas
              }) }}
            {% endif %}
          </div>
        {% else %}
          {# Avatar photo — fixed 44x44px UI element, skipped by transform #}
          <img
            src="{{ imageSrc }}"
            alt="{{ imageAlt }}"
            width="44"
            height="44"
            class="{{ baseClasses }} {{ variantClasses }}"
            loading="{{ imageLoading }}"
            decoding="async"
            eleventy:ignore
            data-image-name="{{ imageData.name }}"
            data-image-type="avatar-photo"
          />
        {% endif %}
      {% else %}
        {# Default — <img> transformed to <picture> by eleventyImageTransformPlugin #}
        <img
          src="{{ imageSrc }}"
          alt="{{ imageAlt }}"
          {% if imageWidth %}width="{{ imageWidth }}"{% endif %}
          {% if imageHeight %}height="{{ imageHeight }}"{% endif %}
          class="{{ baseClasses }} {{ variantClasses }}"
          loading="{{ imageLoading }}"
          decoding="async"
          data-image-name="{{ imageData.name }}"
          data-image-type="default"
        />
      {% endif %}

      {% endif %} {# Close alt validation #}
    {% endif %}
  {% endif %}
{% endmacro %}

{#
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
May your bugs be forever exiled to the shadow realm ✦
HAT · 2026
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#}
