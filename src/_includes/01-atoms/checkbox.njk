{# ┌─────────────────────────────────────────────────────────┐
   │ ATOM › Checkbox                                         │
   │ Accessible checkbox inputs with labels                  │
   └─────────────────────────────────────────────────────────┘ #}

{#
  Props:
    - options.id (string): Checkbox identifier for single rendering
    - options.group (boolean): Render as group if true
    - options.groupName (string): Specific group name to render
    - options.groupSrOnly (boolean): Hide group label visually
    - options.datas (object): Checkbox configuration data
    - options.boxStyles (object): Box styling configuration

  Usage — Summon HAT Components Wisely:
    {% from "01-atoms/checkbox.njk" import renderCheckbox %}

    Single checkbox:
    {{ renderCheckbox({
       id: "charisma",
       datas: atoms.checkboxes,
       boxStyles: atoms.boxes
    }) }}

    Specific group:
    {{ renderCheckbox({
       group: true,
       groupName: "rpgStyles",
       datas: atoms.checkboxes,
       boxStyles: atoms.boxes
    }) }}

    All groups:
    {{ renderCheckbox({
       group: true,
       datas: atoms.checkboxes,
       boxStyles: atoms.boxes
    }) }}

  @created 2025-01-15
#}

{% macro renderCheckbox(options) %}
  {# Validate required props #}
  {% if not options.datas %}
    <span class="error">Error: Missing required prop (datas)</span>
  {% else %}
    {% set checkboxData = options.datas %}

    {# Group rendering #}
    {% if options.group %}
      {% if options.groupName and checkboxData[options.groupName] %}
        {# Render specific group #}
        {{ renderCheckboxGroup(
          checkboxData[options.groupName],
          checkboxData[options.groupName].groupLabel | default(options.groupName)
        ) }}
      {% else %}
        {# Render all groups #}
        {% for groupName, groupConfig in checkboxData %}
          {% if groupConfig.checkboxes %}
            {{ renderCheckboxGroup(
              groupConfig,
              groupConfig.groupLabel | default(groupName)
            ) }}
          {% endif %}
        {% endfor %}
      {% endif %}

    {# Single checkbox rendering #}
    {% else %}
      {% if not options.id %}
        <span class="error">Error: Missing required prop (id) for single checkbox</span>
      {% else %}
        {# Find checkbox in data #}
        {% set targetCheckbox = null %}

        {# Search in flat checkboxes array #}
        {% if checkboxData.checkboxes %}
          {% for checkbox in checkboxData.checkboxes %}
            {% if checkbox.id == options.id %}
              {% set targetCheckbox = checkbox %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {# Search in grouped structure if not found #}
        {% if not targetCheckbox %}
          {% for groupName, groupConfig in checkboxData %}
            {% if groupConfig.checkboxes %}
              {% for checkbox in groupConfig.checkboxes %}
                {% if checkbox.id == options.id %}
                  {% set targetCheckbox = checkbox %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {# Render or show error #}
        {% if targetCheckbox %}
          {{ renderSingleCheckbox(targetCheckbox) }}
        {% else %}
          <span class="error">Checkbox not found: {{ options.id }}</span>
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endmacro %}

{% macro renderCheckboxGroup(groupConfig, groupLabel) %}
  <fieldset
    data-checkbox-group
    {% if groupConfig.ariaGroupLabel %}aria-label="{{ groupConfig.ariaGroupLabel }}"{% endif %}
  >
    {% if groupLabel %}
      <legend {% if groupConfig.groupSrOnly %}class="sr-only"{% endif %}>
        {{ groupLabel }}
      </legend>
    {% endif %}

    {% if groupConfig.groupDescription %}
      <p>{{ groupConfig.groupDescription }}</p>
    {% endif %}

    <div>
      {% for checkbox in groupConfig.checkboxes %}
        {{ renderSingleCheckbox(checkbox) }}
      {% endfor %}
    </div>
  </fieldset>
{% endmacro %}

{% macro renderSingleCheckbox(checkbox) %}
  {# Compute final values #}
  {% set isChecked = checkbox.checked | default(false) %}
  {% set isDisabled = checkbox.disabled | default(false) %}
  {% set isRequired = checkbox.required | default(false) %}
  {% set finalAriaLabel = checkbox.ariaLabel | default(checkbox.label) %}
  {% set hasDescription = checkbox.description %}

  <label
    for="{{ checkbox.id }}"
    data-checkbox-label
  >
    <div>
      <input
        type="checkbox"
        id="{{ checkbox.id }}"
        name="{{ checkbox.id }}"
        value="{{ checkbox.value }}"
        data-checkbox-id="{{ checkbox.id }}"
        data-checkbox-type="checkbox"
        {% if isChecked %}checked{% endif %}
        {% if isDisabled %}disabled{% endif %}
        {% if isRequired %}required{% endif %}
        {% if finalAriaLabel %}aria-label="{{ finalAriaLabel }}"{% endif %}
        {% if hasDescription %}aria-describedby="{{ checkbox.id }}-description"{% endif %}
      />
    </div>

    <div>
      <span>
        {{ checkbox.label }}
        {% if isRequired %}
          <span aria-hidden="true">*</span>
          <span class="sr-only">(required)</span>
        {% endif %}
      </span>

      {% if hasDescription %}
        <p id="{{ checkbox.id }}-description">
          {{ checkbox.description }}
        </p>
      {% endif %}
    </div>
  </label>
{% endmacro %}

{#
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
May your bugs be forever exiled to the shadow realm ✦
Charlotte Carpentier · 2025
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#}
