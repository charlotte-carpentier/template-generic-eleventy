{# ┌─────────────────────────────────────────────────────────┐
   │ ATOM › Input                                            │
   │ Form input fields with validation and states            │
   └─────────────────────────────────────────────────────────┘ #}

{#
  Usage — Summon HAT Components Wisely:
    {% from "01-atoms/input.njk" import renderInput %}

    {{ renderInput({
        name: "demoInput1",
        datas: atoms.input.inputs
    }) }}

  JavaScript Requirements (utils/input.js):
    - Password toggle: Dynamic aria-label ("Show password" / "Hide password")
    - Validation: aria-invalid toggle on error state
    - Character counter: Auto-update on input event

  @created 2025-09-15
  @updated 2026-02-03 (Security Phase: autocomplete + patterns WCAG 1.3.5)
#}

{% macro renderInput(options) %}

  {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
    1. Validate Props
  ━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
  {% if not options.datas %}
    <span class="error" role="alert">Error: Missing required prop (datas)</span>
  {% elif not options.name %}
    <span class="error" role="alert">Error: Missing required prop (name)</span>
  {% else %}
    {# Find input using universal filter #}
    {% set inputData = options.datas | findByName(options.name) %}

    {# Render input or error message #}
    {% if not inputData %}
      <span class="error" role="alert">Input not found: {{ options.name }}</span>
    {% else %}

      {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
        2. Compute Final Values
      ━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
      {% set inputId = inputData.id | default(options.name) %}
      {% set inputName = inputData.name | default(inputId) %}
      {% set inputType = inputData.type | default('text') %}
      {% set inputRows = inputData.rows | default(3) %}
      {% set inputPlaceholder = inputData.placeholder | default('') %}
      {% set isDisabled = options.disabled or inputData.disabled %}

      {# A11y validation: Label or aria-label required (WCAG 3.3.2) #}
      {% if not inputData.label and not inputData.ariaLabel %}
        <span class="error" role="alert">Input requires label or aria-label: {{ options.name }}</span>
      {% else %}

      {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
        3. Tailwind Classes
        Index:
        3.1 Base Input Classes
        3.2 State Classes
        3.3 Label Classes
        3.4 Help Classes
        3.5 Counter Classes
        3.6 Chip Container Classes
        3.7 Password Toggle Button Classes
      ━━━━━━━━━━━━━━━━━━━━━━━━━━ #}

      {# --------------------------
          3.1 Base Input Classes
          Description: Layout, sizing, spacing, typography, borders, focus
      -------------------------- #}
      {% set baseInputClasses = "block w-full px-[var(--spacing-ui-default)] py-[var(--spacing-ui-minimal)] text-body placeholder:italic rounded-[var(--radius-default)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-form-active)] focus-visible:ring-offset-2" %}

      {# --------------------------
          3.2 State Classes
          Description: Colors, background, borders, hover, disabled states
      -------------------------- #}
      {% set stateClasses = "text-[var(--color-global-default)] placeholder:text-[var(--color-global-contrast-light-02)] bg-white border border-[var(--color-form)] hover:border-[var(--color-form-hover)] disabled:bg-[var(--color-global-contrast-light-04)] disabled:opacity-50 disabled:cursor-not-allowed" %}

      {# --------------------------
          3.3 Label Classes
          Description: Layout, spacing, typography, colors
      -------------------------- #}
      {% set labelClasses = "block mb-[var(--spacing-ui-compact)] text-helper font-medium text-[var(--color-global-default)]" %}

      {# --------------------------
          3.4 Help Classes
          Description: Spacing, typography, colors
      -------------------------- #}
      {% set helpClasses = "mt-[var(--spacing-ui-compact)] text-helper text-[var(--color-global-contrast-light-02)]" %}

      {# --------------------------
          3.5 Counter Classes
          Description: Spacing, typography, colors
      -------------------------- #}
      {% set counterClasses = "mt-[var(--spacing-ui-compact)] text-helper text-right text-[var(--color-global-contrast-light-02)]" %}

      {# --------------------------
          3.6 Chip Container Classes
          Description: Layout, spacing
      -------------------------- #}
      {% set chipContainerClasses = "flex flex-wrap gap-[var(--spacing-ui-minimal)] mt-[var(--spacing-ui-default)]" %}

      {# --------------------------
          3.7 Password Toggle Button Classes
          Description: Position, sizing, spacing, colors, focus, target size (WCAG 2.5.8)
      -------------------------- #}
      {% set passwordToggleClasses = "touch-target absolute right-[var(--spacing-ui-compact)] top-1/2 -translate-y-1/2 text-[var(--color-global-contrast-light-02)] hover:text-[var(--color-global-default)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-form-active)] focus-visible:ring-offset-2 rounded transition-colors" %}

      {# --------------------------
          3.8 Error Classes
          Description: Visibility, spacing, typography, colors
      --------------------------- #}
      {% set errorClasses = "hidden mt-[var(--spacing-ui-compact)] text-sm text-[var(--color-semantic-critical)]" %}

      {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
        4. Render HTML
      ━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
      <div class="input-wrapper">
        {# Label #}
        {% if inputData.label %}
          <label for="{{ inputId }}" class="{{ labelClasses }}">
            {{ inputData.label }}{% if inputData.required %}*{% endif %}
          </label>
        {% endif %}

        {# Text Input #}
        {% if inputType in ['text', 'email', 'tel'] %}
          <input
            type="{{ inputType }}"
            id="{{ inputId }}"
            name="{{ inputName }}"
            class="{{ baseInputClasses }} {{ stateClasses }}"
            placeholder="{{ inputPlaceholder }}"
            data-input-name="{{ inputData.name }}"
            data-input-type="input"
            data-error-message="{{ inputData.errorMessage }}"
            aria-invalid="false"
            {% if inputData.required %}required{% endif %}
            {% if inputData.maxLength %}maxlength="{{ inputData.maxLength }}"{% endif %}
            {% if inputData.pattern %}pattern="{{ inputData.pattern }}"{% endif %}
            {% if inputData.autocomplete %}autocomplete="{{ inputData.autocomplete }}"{% endif %}
            {% if isDisabled %}disabled{% endif %}
            {% if inputData.ariaLabel %}aria-label="{{ inputData.ariaLabel }}"{% endif %}
            aria-describedby="{% if inputData.patternMessage %}{{ inputId }}-help {% endif %}{{ inputId }}-error"
          />

        {# Password Input with Toggle #}
        {% elif inputType == 'password' %}
          <div class="relative">
            <input
              type="password"
              id="{{ inputId }}"
              name="{{ inputName }}"
              class="{{ baseInputClasses }} {{ stateClasses }} pr-12"
              placeholder="{{ inputPlaceholder }}"
              data-input-name="{{ inputData.name }}"
              data-input-type="input"
              data-error-message="{{ inputData.errorMessage }}"
              aria-invalid="false"
              {% if inputData.required %}required{% endif %}
              {% if inputData.maxLength %}maxlength="{{ inputData.maxLength }}"{% endif %}
              {% if inputData.pattern %}pattern="{{ inputData.pattern }}"{% endif %}
              {% if inputData.autocomplete %}autocomplete="{{ inputData.autocomplete }}"{% endif %}
              {% if isDisabled %}disabled{% endif %}
              {% if inputData.ariaLabel %}aria-label="{{ inputData.ariaLabel }}"{% endif %}
              aria-describedby="{% if inputData.patternMessage %}{{ inputId }}-help {% endif %}{{ inputId }}-error"
            />
            <button
              type="button"
              class="{{ passwordToggleClasses }}"
              data-password-toggle="{{ inputId }}"
              aria-pressed="false"
              aria-label="Show password"
            ></button>
          </div>

        {# Textarea #}
        {% elif inputType == 'textarea' %}
          <textarea
            id="{{ inputId }}"
            name="{{ inputName }}"
            class="{{ baseInputClasses }} {{ stateClasses }} resize-none"
            placeholder="{{ inputPlaceholder }}"
            rows="{{ inputRows }}"
            data-input-name="{{ inputData.name }}"
            data-input-type="textarea"
            data-error-message="{{ inputData.errorMessage }}"
            aria-invalid="false"
            {% if inputData.required %}required{% endif %}
            {% if inputData.maxLength %}maxlength="{{ inputData.maxLength }}"{% endif %}
            {% if inputData.autocomplete %}autocomplete="{{ inputData.autocomplete }}"{% endif %}
            {% if isDisabled %}disabled{% endif %}
            {% if inputData.ariaLabel %}aria-label="{{ inputData.ariaLabel }}"{% endif %}
            aria-describedby="{% if inputData.maxLength %}{{ inputId }}-count {% endif %}{% if inputData.patternMessage %}{{ inputId }}-help {% endif %}{{ inputId }}-error"
          ></textarea>

          {# Character counter #}
          {% if inputData.maxLength %}
            <div id="{{ inputId }}-count" class="{{ counterClasses }}" aria-live="polite">
              0/{{ inputData.maxLength }}
            </div>
          {% endif %}

        {# Select dropdown #}
        {% elif inputType == 'select' %}
          {% if inputData.selectName and options.selectDatas %}
            {% set selectData = options.selectDatas | findByName(inputData.selectName) %}
            {% if selectData %}
              <select
                id="{{ inputId }}"
                name="{{ inputName }}"
                class="{{ baseInputClasses }} {{ stateClasses }}"
                data-input-name="{{ inputData.name }}"
                data-input-type="select"
                data-error-message="{{ inputData.errorMessage }}"
                aria-invalid="false"
                {% if inputData.required %}required{% endif %}
                {% if inputData.autocomplete %}autocomplete="{{ inputData.autocomplete }}"{% endif %}
                {% if isDisabled %}disabled{% endif %}
                {% if inputData.ariaLabel %}aria-label="{{ inputData.ariaLabel }}"{% endif %}
                aria-describedby="{% if inputData.patternMessage %}{{ inputId }}-help {% endif %}{{ inputId }}-error"
              >
                {% for opt in selectData.options %}
                  <option
                    value="{{ opt.value }}"
                    {% if opt.selected %}selected{% endif %}
                  >
                    {{ opt.label }}
                  </option>
                {% endfor %}
              </select>
            {% else %}
              <span class="error" role="alert">Select data not found: {{ inputData.selectName }}</span>
            {% endif %}
          {% else %}
            <span class="error" role="alert">Missing selectDatas prop or selectName in input data</span>
          {% endif %}

        {# Multiselect #}
        {% elif inputType == 'multiselect' %}
          <div class="input-multiselect" data-input-type="multiselect">
            <select
              id="{{ inputId }}"
              name="{{ inputName }}"
              multiple
              class="{{ baseInputClasses }} {{ stateClasses }}"
              data-input-name="{{ inputData.name }}"
              data-error-message="{{ inputData.errorMessage }}"
              aria-invalid="false"
              {% if inputData.required %}required{% endif %}
              {% if isDisabled %}disabled{% endif %}
              {% if inputData.ariaLabel %}aria-label="{{ inputData.ariaLabel }}"{% endif %}
              aria-describedby="{% if inputData.patternMessage %}{{ inputId }}-help {% endif %}{{ inputId }}-error"
            >
              <option value="">Select options</option>
            </select>

            {% if inputData.chipMulti %}
              <div
                class="{{ chipContainerClasses }}"
                data-chip-container="{{ inputId }}"
                data-chip-template="{{ inputData.chipMulti | dump | escape }}"
              >
              </div>
            {% endif %}
          </div>

        {# Date input #}
        {% elif inputType == 'date' %}
          <input
            type="date"
            id="{{ inputId }}"
            name="{{ inputName }}"
            class="{{ baseInputClasses }} {{ stateClasses }}"
            placeholder="{{ inputPlaceholder }}"
            data-input-name="{{ inputData.name }}"
            data-input-type="date"
            data-error-message="{{ inputData.errorMessage }}"
            aria-invalid="false"
            {% if inputData.required %}required{% endif %}
            {% if inputData.autocomplete %}autocomplete="{{ inputData.autocomplete }}"{% endif %}
            {% if isDisabled %}disabled{% endif %}
            {% if inputData.ariaLabel %}aria-label="{{ inputData.ariaLabel }}"{% endif %}
            aria-describedby="{% if inputData.patternMessage %}{{ inputId }}-help {% endif %}{{ inputId }}-error"
          />

        {# Phone input #}
        {% elif inputType == 'phone' %}
          <input
            type="tel"
            id="{{ inputId }}"
            name="{{ inputName }}"
            class="{{ baseInputClasses }} {{ stateClasses }}"
            placeholder="{{ inputPlaceholder }}"
            data-input-name="{{ inputData.name }}"
            data-input-type="phone"
            data-error-message="{{ inputData.errorMessage }}"
            aria-invalid="false"
            {% if inputData.required %}required{% endif %}
            {% if inputData.maxLength %}maxlength="{{ inputData.maxLength }}"{% endif %}
            {% if inputData.autocomplete %}autocomplete="{{ inputData.autocomplete }}"{% endif %}
            {% if isDisabled %}disabled{% endif %}
            {% if inputData.ariaLabel %}aria-label="{{ inputData.ariaLabel }}"{% endif %}
            aria-describedby="{% if inputData.patternMessage %}{{ inputId }}-help {% endif %}{{ inputId }}-error"
          />

        {# Panel input #}
        {% elif inputType == 'panel' %}
          <textarea
            id="{{ inputId }}"
            name="{{ inputName }}"
            class="{{ baseInputClasses }} {{ stateClasses }} resize-none"
            placeholder="{{ inputPlaceholder }}"
            rows="{{ inputRows }}"
            data-input-name="{{ inputData.name }}"
            data-input-type="panel"
            data-error-message="{{ inputData.errorMessage }}"
            aria-invalid="false"
            {% if inputData.required %}required{% endif %}
            {% if inputData.autocomplete %}autocomplete="{{ inputData.autocomplete }}"{% endif %}
            {% if isDisabled %}disabled{% endif %}
            {% if inputData.ariaLabel %}aria-label="{{ inputData.ariaLabel }}"{% endif %}
            aria-describedby="{% if inputData.patternMessage %}{{ inputId }}-help {% endif %}{{ inputId }}-error"
          ></textarea>

        {% else %}
          <span class="error" role="alert">Unsupported input type: {{ inputType }}</span>
        {% endif %}

        {# Help text - Pattern message #}
        {% if inputData.patternMessage %}
          <div id="{{ inputId }}-help" class="{{ helpClasses }}">
            {{ inputData.patternMessage }}
          </div>
        {% endif %}

        {# Error container (hidden by default, JS shows on validation error) #}
        <div id="{{ inputId }}-error" class="{{ errorClasses }}" role="alert"></div>
      </div>

      {% endif %}
    {% endif %}
  {% endif %}
{% endmacro %}

{#
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
May your bugs be forever exiled to the shadow realm ✦
HAT · 2026
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#}
