{# ┌─────────────────────────────────────────────────────────┐
   │ MOLECULE › Card                                         │
   │ Flexible card component with image, heading and CTA     │
   └─────────────────────────────────────────────────────────┘ #}

{#
  Usage — Summon HAT Components Wisely:
    {% from "02-molecules/card.njk" import renderCard %}
    
    Regular card:
    {{ renderCard({ 
        name: "goblin_menace",
        variant: "default",
        datas: molecules.cards,
        images: atoms.images,
        headings: atoms.headings,
        buttons: atoms.buttons
    }) }}
    
    Post card:
    {{ renderCard({ 
        name: "post_template", 
        datas: molecules.cards,
        buttons: atoms.buttons,
        post: post
    }) }}
  
  Props:
    - options.name (string): Card identifier
    - options.variant (string): Card style variant
    - options.datas (object): Card configuration
    - options.images (object): Images atom data
    - options.headings (object): Headings atom data
    - options.buttons (object): Buttons atom data
    - options.post (object): Post data for blog cards (optional)
    - options.class (string): Additional CSS classes
  
  Card Types:
    - Regular: Image + Heading + Content + Button
    - Post: Blog post with author, date, and read more link
  
  Features:
    - Responsive image support
    - Heading levels (h1-h6)
    - Content text with line clamping
    - Button with hover/focus states
    - Post metadata (author, date)
  
  @created 2025-01-15
#}

{% macro renderCard(options) %}
  {% if options.datas %}
    {% set globalStyle = options.datas.globalStyle %}
    {% set widthStyle = options.datas.widthStyle | default('') %}
    
    {% set cardData = null %}
    {% if options.name %}
      {% for cardItem in options.datas.cards %}
        {% if cardItem.name == options.name %}
          {% set cardData = cardItem %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if not cardData %}
      {% set cardData = options.datas.cards[0] %}
    {% endif %}
    
    {# Check if this is a post card #}
    {% set isPostCard = cardData.type == 'post' %}
    
    {# Get variant style #}
    {% set variantStyle = '' %}
    {% if isPostCard %}
      {% set variantStyle = options.datas.variants.post %}
    {% else %}
      {% set variantStyle = options.datas.variants[options.variant] | default(options.datas.variants.default) %}
    {% endif %}
    
    {# For regular cards, render normally #}
    {% if not isPostCard and not options.post %}
      <div class="{{ globalStyle }} {{ widthStyle }} {{ variantStyle }} {{ options.class | default('') }}">
        {# Image section #}
        {% if cardData.image and options.images %}
          {% set imageData = null %}
          {% for img in options.images.images %}
            {% if img.name == cardData.image.name %}
              {% set imageData = img %}
            {% endif %}
          {% endfor %}
          
          {% if imageData %}
            {% set imgSize = options.images.variants[imageData.size] | default('') %}
            <div>
              <img 
                src="{{ imageData.src }}" 
                alt="{{ imageData.alt }}" 
                class="{{ options.images.globalStyle }} {{ imgSize }}"
              >
            </div>
          {% endif %}
        {% endif %}
        
        {# Content section #}
        <div class="{{ options.datas.contentStyle }}">
          {# Render heading if present #}
          {% if cardData.heading and options.headings %}
            {% set headingData = null %}
            {% for heading in options.headings.headings %}
              {% if heading.name == cardData.heading.name %}
                {% set headingData = heading %}
              {% endif %}
            {% endfor %}
            
            {% if headingData %}
              {% set hLevel = headingData.level | default(3) %}
              {% set headingStyle = options.headings.variants[headingData.style] | default(options.headings.variants.default) %}
              {% set sizeStyle = options.headings.sizeStyles['h' + hLevel] | default('') %}
              
              <h{{ hLevel }} class="{{ options.headings.globalStyle }} {{ sizeStyle }} {{ headingStyle }}">
                {{ headingData.text }}
              </h{{ hLevel }}>
            {% endif %}
          {% endif %}
          
          {# Render content text #}
          {% if cardData.content %}
            {% set contentStyle = options.datas.contentStyles[cardData.content.style] | default(options.datas.contentStyles.default) %}
            {% set maxLines = cardData.content.maxLines | default(0) %}
            <p class="{{ contentStyle }}">{{ cardData.content.text }}</p>
          {% endif %}
          
          {# Render button if present #}
          {% if cardData.button and options.buttons %}
            {% set buttonData = null %}
            {% for button in options.buttons.buttons %}
              {% if button.name == cardData.button.name %}
                {% set buttonData = button %}
              {% endif %}
            {% endfor %}
            
            {% if buttonData %}
              {% set btnVariant = buttonData.style | default('primary') %}
              {% set btnSize = buttonData.size | default('button') %}
              {% set btnDefaultState = options.buttons.variants[btnVariant].default | default('') %}
              {% set btnSizeStyle = options.buttons.sizes[btnSize] | default('') %}
              
              <div>
                <a 
                  href="{{ buttonData.href | default('#') }}" 
                  class="{{ options.buttons.globalStyle }} {{ btnDefaultState }} {{ btnSizeStyle }}"
                  {% if buttonData.target %}target="{{ buttonData.target }}"{% endif %}
                  onmouseover="this.className='{{ options.buttons.globalStyle }} {{ options.buttons.variants[btnVariant].hover }} {{ btnSizeStyle }}'"
                  onmouseout="this.className='{{ options.buttons.globalStyle }} {{ btnDefaultState }} {{ btnSizeStyle }}'"
                  onfocus="this.className='{{ options.buttons.globalStyle }} {{ options.buttons.variants[btnVariant].focus }} {{ btnSizeStyle }}'"
                  onblur="this.className='{{ options.buttons.globalStyle }} {{ btnDefaultState }} {{ btnSizeStyle }}'"
                >
                  {% if buttonData.iconBefore %}
                    <img src="{{ buttonData.iconBefore }}" alt="">
                  {% endif %}
                  
                  {{ buttonData.text }}
                  
                  {% if buttonData.iconAfter %}
                    <img src="{{ buttonData.iconAfter }}" alt="">
                  {% endif %}
                </a>
              </div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    {% else %}
      {# For post cards, render with the post structure #}
      {% set postCard = cardData %}
      {% if options.post %}
        {% set post = options.post %}
        <li>
          <article class="{{ variantStyle }} {{ options.class | default('') }}">
            <div class="{{ postCard.imageStyle | default('') }}">
              <img src="{{ post.data.image }}" alt="{{ post.data.title }}">
            </div>
            <div class="{{ options.datas.contentStyles.post | default('') }}">
              <h3 class="{{ postCard.titleStyle | default('') }}">{{ post.data.title }}</h3>
              <p class="{{ postCard.metaStyle | default('') }}">by
                <span>{{ post.data.author }}</span>
                on
                <span>{{ post.data.date | postDate }}</span>
              </p>
              <p class="{{ postCard.descriptionStyle | default('') }}">{{ post.data.description }}</p>
              <div class="{{ postCard.buttonContainerStyle | default('') }}">
                {% if options.buttons %}
                  {% set btnName = postCard.buttonName | default('read_more') %}
                  {% set buttonData = null %}
                  {% for button in options.buttons.buttons %}
                    {% if button.name == btnName %}
                      {% set buttonData = button %}
                    {% endif %}
                  {% endfor %}
                  
                  {% if buttonData %}
                    {% set btnVariant = buttonData.style | default('primary') %}
                    {% set btnSize = buttonData.size | default('button') %}
                    {% set btnDefaultState = options.buttons.variants[btnVariant].default | default('') %}
                    {% set btnSizeStyle = options.buttons.sizes[btnSize] | default('') %}
                    
                    <a 
                      href="{{ post.url }}" 
                      class="{{ options.buttons.globalStyle }} {{ btnDefaultState }} {{ btnSizeStyle }}"
                      onmouseover="this.className='{{ options.buttons.globalStyle }} {{ options.buttons.variants[btnVariant].hover }} {{ btnSizeStyle }}'"
                      onmouseout="this.className='{{ options.buttons.globalStyle }} {{ btnDefaultState }} {{ btnSizeStyle }}'"
                      onfocus="this.className='{{ options.buttons.globalStyle }} {{ options.buttons.variants[btnVariant].focus }} {{ btnSizeStyle }}'"
                      onblur="this.className='{{ options.buttons.globalStyle }} {{ btnDefaultState }} {{ btnSizeStyle }}'"
                    >
                      {% if buttonData.iconBefore %}
                        <img src="{{ buttonData.iconBefore }}" alt="">
                      {% endif %}
                      
                      {{ buttonData.text }}
                      
                      {% if buttonData.iconAfter %}
                        <img src="{{ buttonData.iconAfter }}" alt="">
                      {% endif %}
                    </a>
                  {% else %}
                    <a href="{{ post.url }}">Read more</a>
                  {% endif %}
                {% else %}
                  <a href="{{ post.url }}">Read more</a>
                {% endif %}
              </div>
            </div>
          </article>
        </li>
      {% else %}
        <span>Post data not provided for post card type</span>
      {% endif %}
    {% endif %}
  {% else %}
    <span>Card data not found</span>
  {% endif %}
{% endmacro %}


{#
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
May your bugs be forever exiled to the shadow realm ✦
Charlotte Carpentier · 2025
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#}