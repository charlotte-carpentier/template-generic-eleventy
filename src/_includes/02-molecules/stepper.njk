{# ┌─────────────────────────────────────────────────────────┐
   │ MOLECULE › Stepper                                      │
   │ Multi-step progress indicator with status tracking      │
   └─────────────────────────────────────────────────────────┘ #}

{#
  Props:
    - options.name (string): Stepper identifier
    - options.datas (array): Stepper configuration data
    - options.chipDatas (array): Chip notification atom data (optional)

  Usage — Summon HAT Components Wisely:
    {% from "02-molecules/stepper.njk" import renderStepper %}

    {{ renderStepper({
        name: "demoStep1",
        datas: molecules.stepper.steppers,
        chipDatas: atoms["chip-notification"].chipNotifs
    }) }}

  @created 2025-09-15
#}

{% from "01-atoms/chip-notification.njk" import renderChipNotification %}

{% macro renderStepper(options) %}

  {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
    1. Validate Props
  ━━━━━━━━━━━━━━━━━━━━━━━━━ #}
  {% if not options.datas %}
    <span class="error" role="alert">Error: Missing required prop (datas)</span>
  {% elif not options.name %}
    <span class="error" role="alert">Error: Missing required prop (name)</span>
  {% else %}
    {# Find stepper using universal filter #}
    {% set stepperData = options.datas | findByName(options.name) %}

    {# Render stepper or error message #}
    {% if not stepperData %}
      <span class="error" role="alert">Stepper not found: {{ options.name }}</span>
    {% else %}

      {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
        2. Compute Final Values
      ━━━━━━━━━━━━━━━━━━━━━━━━━ #}
      {% set stepperName = stepperData.name | default(options.name) %}
      {% set variant = stepperData.variant | default('default') %}
      {% set items = stepperData.items | default([]) %}

      {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
        3. Tailwind Classes
        Index:
        3.1 Wrapper Classes
        3.2 List Classes
        3.3 Connector Classes
        3.4 Block Step Classes
        3.5 Chip Wrapper Classes
        3.6 Chip Override Classes
        3.7 Number Fallback Classes
        3.8 Label Classes
        3.9 Vertical Wrapper Classes
        3.10 Chip Column Classes
      ━━━━━━━━━━━━━━━━━━━━━━━━━ #}

      {# --------------------------
          3.1 Wrapper Classes
          Description: Base container
        --------------------------#}
      {% set containerClasses = "" %}

      {# --------------------------
          3.2 List Classes
          Description: Layout by variant
        --------------------------#}
      {% set listVariantMap = {
        'vertical': 'flex flex-col gap-[var(--spacing-ui-minimal)]',
        'default': 'flex flex-col gap-[var(--spacing-ui-minimal)] md:flex-row md:items-center md:gap-[var(--spacing-ui-minimal)]'
      } %}
      {% set listClasses = listVariantMap[variant] or listVariantMap['default'] %}

      {# --------------------------
          3.3 Connector Classes
          Description: Line between steps
        --------------------------#}
      {% set connectorVariantMap = {
        'vertical': 'mt-[var(--spacing-ui-minimal)] w-px h-6 bg-[var(--color-global-contrast-light-02)]',
        'default': 'mt-[var(--spacing-ui-minimal)] w-px h-6 bg-[var(--color-global-contrast-light-02)] md:mt-0 md:h-px md:w-12 md:flex-shrink-0'
      } %}
      {% set connectorClasses = connectorVariantMap[variant] or connectorVariantMap['default'] %}

      {# --------------------------
          3.4 Block Step Classes
          Description: Layout horizontal (chip + label)
        --------------------------#}
      {% set blockStepClasses = "flex items-center gap-[var(--spacing-ui-compact)]" %}

      {# --------------------------
          3.5 Chip Wrapper Classes
          Description: Wrapper for chip
        --------------------------#}
      {% set chipWrapperClasses = "flex-shrink-0" %}

      {# --------------------------
          3.6 Chip Override Classes
          Description: Color overrides for chip based on step status
        --------------------------#}
      {% set chipOverrideMap = {
        'active': '[&_span]:bg-[var(--color-button-primary)]',
        'upcoming': '[&_span]:text-[var(--color-global-contrast-light-02)] [&_span]:bg-[var(--color-global-contrast-light-04)]',
        'done': '[&_span]:bg-[var(--color-semantic-success)]'
      } %}

      {# --------------------------
          3.7 Number Fallback Classes
          Description: Fallback number when no chip
        --------------------------#}
      {% set numberFallbackClasses = "flex items-center justify-center w-8 h-8 font-body text-lg text-[var(--color-global-default)] bg-[var(--color-global-contrast-light-03)] rounded-full" %}

      {# --------------------------
          3.8 Label Classes
          Description: Typography, Colors by status
        --------------------------#}
      {% set labelStatusMap = {
        'active': 'font-body text-body text-[var(--color-global-default)]',
        'upcoming': 'font-body text-body text-[var(--color-global-contrast-light-02)]',
        'done': 'font-body text-body text-[var(--color-semantic-success)]'
      } %}

      {# --------------------------
          3.9 Vertical Wrapper Classes
          Description: Wrapper for vertical layout (chip column + label)
        --------------------------#}
      {% set verticalWrapperClasses = "flex gap-[var(--spacing-ui-compact)]" %}

      {# --------------------------
          3.10 Chip Column Classes
          Description: Column for chip + connector in vertical layout
        --------------------------#}
      {% set chipColumnClasses = "flex flex-col items-center flex-shrink-0" %}

      {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
        4. Render HTML
      ━━━━━━━━━━━━━━━━━━━━━━━━━ #}
      <div
        class="{{ containerClasses }}"
        data-stepper-name="{{ stepperName }}"
        data-stepper-type="stepper"
        data-stepper-variant="{{ variant }}"
        role="navigation"
        aria-label="Progress stepper"
      >
        {# Steps list #}
        <div
          class="{{ listClasses }}"
          data-stepper-list="true"
        >
          {% for item in items %}
            {# Compute item values #}
            {% set status = item.status | default('upcoming') %}
            {% set label = item.label | default('') %}
            {% set chipName = item.chipName | default('') %}

            {# Get classes from mappings #}
            {% set chipOverride = chipOverrideMap[status] or chipOverrideMap['upcoming'] %}
            {% set labelClasses = labelStatusMap[status] or labelStatusMap['upcoming'] %}

            {# VERTICAL LAYOUT #}
            {% if variant == 'vertical' %}
              <div
                class="{{ verticalWrapperClasses }}"
                data-block-step="true"
                data-block-step-status="{{ status }}"
                data-block-step-index="{{ loop.index }}"
              >
                {# Chip column #}
                <div class="{{ chipColumnClasses }}">
                  <div class="{{ chipWrapperClasses }} {{ chipOverride }}">
                    {{ renderChipNotification({
                        name: chipName,
                        datas: options.chipDatas
                    }) }}
                  </div>
                  {% if not loop.last %}
                    <div class="{{ connectorClasses }}" data-stepper-connector="true"></div>
                  {% endif %}
                </div>
                {# Label #}
                <span
                  class="{{ labelClasses }}"
                  data-block-step-label="true"
                >
                  {{ label }}
                </span>
              </div>

            {# HORIZONTAL LAYOUT #}
            {% else %}
              <div
                class="{{ blockStepClasses }}"
                data-block-step="true"
                data-block-step-status="{{ status }}"
                data-block-step-index="{{ loop.index }}"
              >
                <div class="{{ chipWrapperClasses }} {{ chipOverride }}">
                  {{ renderChipNotification({
                      name: chipName,
                      datas: options.chipDatas
                  }) }}
                </div>
                <span
                  class="{{ labelClasses }}"
                  data-block-step-label="true"
                >
                  {{ label }}
                </span>
              </div>
              {% if not loop.last %}
                <div class="{{ connectorClasses }}" data-stepper-connector="true"></div>
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
    {% endif %}
  {% endif %}
{% endmacro %}

{#
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
May your bugs be forever exiled to the shadow realm ✦
HAT · 2026
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#}
