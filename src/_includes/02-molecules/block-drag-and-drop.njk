{# ┌─────────────────────────────────────────────────────────┐
   │ MOLECULE › Block Drag and Drop                          │
   │ File upload with drag and drop support                  │
   └─────────────────────────────────────────────────────────┘ #}

{#
  Props:
    - options.name (string): Block drag and drop identifier
    - options.datas (array): Block drag and drop configuration data
    - options.headingDatas (array): Heading atom data
    - options.iconDatas (array): Icon atom data
    - options.buttonDatas (array): Button atom data
    - options.tooltipDatas (array): Tooltip atom data (optional, required if buttons have tooltips)

  Usage — Summon HAT Components Wisely:
    {% from "02-molecules/block-drag-and-drop.njk" import renderBlockDragAndDrop %}

    {{ renderBlockDragAndDrop({
        name: "demoDragDrop1",
        datas: molecules["block-drag-and-drop"].blockDnDs,
        headingDatas: atoms.heading.headings,
        iconDatas: atoms.icon.icons,
        buttonDatas: atoms.button.buttons
    }) }}

  JavaScript Requirements:
    - JS MUST trigger file input on Enter/Space key
    - JS MUST announce file selected via aria-live region
    - JS MUST announce errors via aria-live region

  @created 2025-01-15
  @updated 2026-01-06 (WCAG 2.2 AA compliance)
#}

{% from "01-atoms/heading.njk" import renderHeading %}
{% from "01-atoms/icon.njk" import renderIcon %}
{% from "01-atoms/button.njk" import renderButton %}

{% macro renderBlockDragAndDrop(options) %}

  {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
    1. Validate Props
  ━━━━━━━━━━━━━━━━━━━━━━━━━ #}
  {% if not options.datas %}
    <span class="error" role="alert">Error: Missing required prop (datas)</span>
  {% elif not options.name %}
    <span class="error" role="alert">Error: Missing required prop (name)</span>
  {% else %}
    {# Find block using universal filter #}
    {% set blockData = options.datas | findByName(options.name) %}

    {# Render block or error message #}
    {% if not blockData %}
      <span class="error" role="alert">Block drag and drop not found: {{ options.name }}</span>
    {% else %}

      {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
        2. Compute Final Values
      ━━━━━━━━━━━━━━━━━━━━━━━━━ #}
      {% set headingName = blockData.headingName | default('') %}
      {% set iconName = blockData.iconName | default('') %}
      {% set buttonName = blockData.buttonName | default('') %}
      {% set dropzoneText = blockData.dropzoneText | default('Drag and drop file here') %}
      {% set separator = blockData.separator | default('Or') %}
      {% set variant = blockData.variant | default('default') %}
      {% set errorMessage = blockData.errorMessage | default('') %}
      {% set supportedFormatsLabel = blockData.supportedFormatsLabel | default('Supported formats') %}
      {% set supportedFormatsValue = blockData.supportedFormatsValue | default('') %}
      {% set maxFileSizeLabel = blockData.maxFileSizeLabel | default('Maximum file size') %}
      {% set maxFileSizeValue = blockData.maxFileSizeValue | default('') %}

      {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
        3. Tailwind Classes
        Index:
        3.1 Wrapper Classes
        3.2 Heading Wrapper Classes
        3.3 Dropzone Classes (by variant: default, loading, error)
        3.4 Icon Wrapper Classes
        3.5 Dropzone Text Classes
        3.6 Separator Classes
        3.7 Button Wrapper Classes
        3.8 File Info Classes
        3.9 Error Message Classes
        3.10 ARIA Live Region Classes
      ━━━━━━━━━━━━━━━━━━━━━━━━━ #}

      {# --------------------------
          3.1 Wrapper Classes
          Description: Layout, Composition, Spacing
        --------------------------#}
      {% set containerClasses = "flex flex-col p-[var(--spacing-inset-small)] bg-[var(--color-global-white)] rounded-[var(--radius-card)] shadow-[var(--elevation-surface)] w-full max-w-xl" %}

      {# --------------------------
          3.2 Heading Wrapper Classes
          Description: Spacing, Layout
        --------------------------#}
      {% set headingContainerClasses = "mb-[var(--spacing-stack-large)]" %}

      {# --------------------------
          3.3 Dropzone Classes (by variant: default, loading, error)
          Description: Layout, Spacing, Colors, Borders, Effects, States
        --------------------------#}
      {% set dropzoneBaseClasses = "touch-target flex flex-col items-start justify-center p-[var(--spacing-inset-large)] border border-[var(--color-global-contrast-light-03)] rounded-[var(--radius-card)] bg-[var(--color-global-white)] min-h-[160px] w-full cursor-pointer transition-colors mb-[var(--spacing-stack-medium)] focus:outline-none focus:ring-2 focus:ring-[var(--color-semantic-information-focus)] focus:ring-offset-2" %}
      {% set dropzoneHoverClasses = "hover:bg-[var(--color-global-contrast-light-03)]" %}

      {% set variantMap = {
        'default': '',
        'loading': 'pointer-events-none opacity-60',
        'error': 'border-[var(--color-semantic-critical)]'
      } %}
      {% set dropzoneVariantClasses = variantMap[variant] | default('') %}

      {% set dropzoneClasses = dropzoneBaseClasses ~ " " ~ dropzoneHoverClasses ~ " " ~ dropzoneVariantClasses %}

      {# --------------------------
          3.4 Icon Wrapper Classes
          Description: Spacing, Colors
        --------------------------#}
      {% set iconContainerClasses = "mb-[var(--spacing-stack-small)] text-[var(--color-global-contrast-light-02)]" %}

      {# --------------------------
          3.5 Dropzone Text Classes
          Description: Typography, Colors
        --------------------------#}
      {% set dropzoneTextClasses = "font-body text-body text-[var(--color-global-default)]" %}

      {# --------------------------
          3.6 Separator Classes
          Description: Spacing, Typography, Colors
        --------------------------#}
      {% set separatorClasses = "block my-[var(--spacing-stack-medium)] font-body text-body text-[var(--color-global-default)]" %}

      {# --------------------------
          3.7 Button Wrapper Classes
          Description: Spacing, Layout
        --------------------------#}
      {% set buttonContainerClasses = "flex mb-[var(--spacing-stack-medium)]" %}

      {# --------------------------
          3.8 File Info Classes
          Description: Layout, Spacing, Typography, Colors
        --------------------------#}
      {% set fileInfoContainerClasses = "flex flex-col gap-[var(--spacing-inline-small)] mt-[var(--spacing-stack-tight)]" %}
      {% set fileInfoLabelClasses = "text-sm text-[var(--color-global-contrast-light-02)]" %}
      {% set fileInfoValueClasses = "text-sm text-[var(--color-global-default)]" %}

      {# --------------------------
          3.9 Error Message Classes
          Description: Typography, Colors, Spacing
        --------------------------#}
      {% set errorMessageClasses = "font-body text-sm text-[var(--color-semantic-critical)] mt-[var(--spacing-stack-tight)]" %}

      {# --------------------------
          3.10 ARIA Live Region Classes
          Description: Screen reader only
        --------------------------#}
      {% set ariaLiveClasses = "sr-only" %}

      {# ━━━━━━━━━━━━━━━━━━━━━━━━━━
        4. Render HTML
      ━━━━━━━━━━━━━━━━━━━━━━━━━ #}
      <div
        class="{{ containerClasses }}"
        data-drag-drop-name="{{ blockData.name }}"
        data-drag-drop-type="block-drag-and-drop"
        data-drag-drop="true"
        aria-dropeffect="copy"
        {% if supportedFormatsValue %}data-allowed-types="{{ supportedFormatsValue | lower | replace(' ', '') }}"{% endif %}
        {% if maxFileSizeValue %}data-max-size="{{ maxFileSizeValue | lower | replace(' ', '') }}"{% endif %}
      >
        {# Heading #}
        <div class="{{ headingContainerClasses }}">
          {{ renderHeading({
              name: headingName,
              datas: options.headingDatas
          }) }}
        </div>

        {# Dropzone - Native button for keyboard access #}
        <button
          type="button"
          class="{{ dropzoneClasses }}"
          data-drag-drop-zone="true"
          aria-label="{{ dropzoneText }}"
          aria-describedby="file-info-{{ blockData.name }}"
          {% if variant == 'loading' %}aria-busy="true" disabled{% endif %}
        >
          {# Icon #}
          <div class="{{ iconContainerClasses }}">
            {{ renderIcon({
                name: iconName,
                datas: options.iconDatas,
                decorative: true
            }) }}
          </div>

          {# Dropzone text #}
          <span class="{{ dropzoneTextClasses }}" data-drag-drop-text="true">
            {{ dropzoneText }}
          </span>
        </button>

        {# Separator #}
        <span class="{{ separatorClasses }}">{{ separator }}</span>

        {# Button #}
        <div class="{{ buttonContainerClasses }}" data-drag-drop-button="true">
          {{ renderButton({
              name: buttonName,
              datas: options.buttonDatas,
              iconDatas: options.iconDatas,
              tooltipDatas: options.tooltipDatas,
              disabled: variant == 'loading'
          }) }}
        </div>

        {# File info #}
        <div class="{{ fileInfoContainerClasses }}" id="file-info-{{ blockData.name }}" data-drag-drop-info="true">
          <p>
            <span class="{{ fileInfoLabelClasses }}">{{ supportedFormatsLabel }} </span>
            <span class="{{ fileInfoValueClasses }}">{{ supportedFormatsValue }}</span>
          </p>
          <p>
            <span class="{{ fileInfoLabelClasses }}">{{ maxFileSizeLabel }} </span>
            <span class="{{ fileInfoValueClasses }}">{{ maxFileSizeValue }}</span>
          </p>
        </div>

        {# Error message #}
        {% if variant == 'error' and errorMessage %}
          <p class="{{ errorMessageClasses }}" role="alert" data-drag-drop-error="true">
            {{ errorMessage }}
          </p>
        {% endif %}

        {# ARIA live region for screen readers #}
        <div
          class="{{ ariaLiveClasses }}"
          role="status"
          aria-live="polite"
          aria-atomic="true"
          data-drag-drop-status="true"
        ></div>

        {# Hidden file input with proper label #}
        <label for="file-{{ blockData.name }}" class="sr-only">
          Choose file or drag and drop
        </label>
        <input
          type="file"
          id="file-{{ blockData.name }}"
          class="sr-only"
          data-drag-drop-input="true"
          aria-describedby="file-info-{{ blockData.name }}"
          {% if supportedFormatsValue %}accept="{{ supportedFormatsValue | lower | replace(' ', '') }}"{% endif %}
        >
      </div>
    {% endif %}
  {% endif %}
{% endmacro %}

{#
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
May your bugs be forever exiled to the shadow realm ✦
HAT · 2026
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#}
